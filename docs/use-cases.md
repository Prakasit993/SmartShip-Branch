# Use Cases – SmartShip Branch Assistant

---

## UC-01: Create Shipment Draft & QR (Branch System – Part 1)

### Overview
ลูกค้ามาที่สาขา พนักงานเก็บข้อมูลผู้ส่ง/ผู้รับ โดยล็อกที่อยู่ผู้ส่งให้เป็นที่อยู่สาขา  
จากนั้นระบบสร้าง Shipment Draft และ QR Code สำหรับใช้ในขั้นตอนรับเข้าระบบ J&T (Part 2)

### Basic Info
- **Use Case ID:** UC-01  
- **Name:** Create Shipment Draft & QR  
- **Primary Actor:** Branch Staff  
- **Secondary Actors:** Customer, SmartShip System, J&T System (VIP Lookup – ในอนาคต)  
- **Trigger:** ลูกค้าแจ้งความต้องการส่งพัสดุที่เคาน์เตอร์

### Goal
สร้างข้อมูลพัสดุให้ครบถ้วนในระบบสาขา (SmartShip)  
โดยล็อกที่อยู่ผู้ส่ง = ที่อยู่สาขา และเตรียม QR Code ที่มีข้อมูลครบสำหรับส่งต่อให้ระบบ J&T

### Preconditions
- Branch Staff ล็อกอิน Staff Portal ของ SmartShip แล้ว  
- ข้อมูลสาขา (`branch` record) ถูกตั้งค่าเรียบร้อย (มีที่อยู่สาขา)  
- ระบบฐานข้อมูล SmartShip พร้อมใช้งาน  
- (ถ้าใช้ VIP Lookup) ระบบสามารถเชื่อมต่อ J&T VIP API ได้ หรือกำหนด flow ไว้แล้วว่า “ยังไม่ใช้”

### Postconditions (Success)
- มี record ใหม่ในตาราง `shipments` สถานะ `draft`  
- Shipment ผูกกับสาขา (`branch_id`) และลูกค้า (`customer_id` ถ้ามี)  
- ระบบสร้าง QR Code ที่ encode ข้อมูลสำคัญ เช่น
  - branch code  
  - vip_code (ถ้ามี)  
  - sender_name / sender_phone  
  - receiver_name / receiver_phone  
  - receiver full address + postal code  
- QR Code ถูกแสดงบนหน้าจอ / พิมพ์ออกสติ๊กเกอร์ พร้อมใช้งานใน UC-02

### Postconditions (Failure)
- ไม่สร้าง Shipment Draft  
- ระบบแจ้ง error ให้พนักงานทราบ (เช่น DB ล่ม / ข้อมูลไม่ครบ)

---

### Main Flow (Success Scenario)

1. **ลูกค้ามาถึงสาขา** และแจ้งพนักงานว่าต้องการส่งพัสดุ  
2. **Branch Staff เปิด Staff Portal** เลือกเมนู `สร้างพัสดุ (ส่วนที่ 1)`  
3. ระบบแสดงฟอร์มเก็บข้อมูล:
   - ชื่อลูกค้า (ผู้ส่ง)  
   - เบอร์โทรลูกค้า (ผู้ส่ง)  
   - ชื่อผู้รับ  
   - เบอร์โทรผู้รับ  
   - ที่อยู่ผู้รับ (บ้านเลขที่/หมู่/ซอย/ถนน/ตำบล/อำเภอ/จังหวัด/รหัสไปรษณีย์)  
4. Branch Staff กรอกข้อมูลตามที่ลูกค้าให้มา  
5. ระบบดึงข้อมูลสาขาจากตาราง `branches`  
   - ตั้งค่า **sender address** เป็นที่อยู่สาขา (ล็อก ไม่ให้แก้ไข)  
6. (ถ้าเปิดใช้ VIP Lookup)  
   1. ระบบใช้เบอร์โทรลูกค้า (`sender_phone`) เรียก J&T VIP API  
   2. ถ้าพบลูกค้า → ได้ `vip_code`  
   3. ถ้าไม่พบ → ปล่อย `vip_code = null` และทำต่อได้ตามปกติ  
7. ระบบสร้าง/อัปเดต record ในตาราง `customers`  
   - ถ้ามีเบอร์โทรนี้อยู่แล้ว → อัปเดตข้อมูลชื่อ / vip_code  
   - ถ้าไม่มี → สร้างลูกค้าใหม่  
8. ระบบสร้าง record ใหม่ในตาราง `shipments` สถานะ `draft` โดยบันทึก:
   - `branch_id` (สาขาปัจจุบัน)  
   - `customer_id` (ผู้ส่ง)  
   - `sender_name`, `sender_phone`  
   - `receiver_name`, `receiver_phone`, ที่อยู่เต็ม + `receiver_postal_code`  
   - `vip_code` (ถ้ามี)  
9. ระบบสร้าง **QR Payload** จากข้อมูลใน shipment (เช่น JSON หรือข้อความคั่นด้วย `|`)  
10. ระบบสร้าง QR Code จาก payload และบันทึก/ผูกกับ shipment นั้น  
11. ระบบแสดงหน้าจอสรุปข้อมูล + QR Code ให้พนักงาน  
12. Branch Staff แสดง QR ให้ลูกค้า/หรือพิมพ์สติ๊กเกอร์ติดกล่อง → เสร็จสิ้น UC-01

---

### Alternative & Exception Flows

#### A1 – ข้อมูลไม่ครบหรือรูปแบบผิด (ฟิลด์ทั่วไป)

- ระบบตรวจสอบฟิลด์บังคับ (ชื่อ, เบอร์โทร, ที่อยู่) และรูปแบบเบอร์โทร
- หากพบว่ามีฟิลด์ว่าง หรือรูปแบบไม่ถูกต้อง (เช่น เบอร์โทรไม่ใช่ตัวเลข 10 หลัก)
- ระบบแสดงข้อความแจ้งเตือนใต้ฟิลด์ที่ผิด และไม่อนุญาตให้ไปขั้นตอนถัดไป
- Branch Staff ต้องแก้ไขข้อมูลให้ถูกต้อง แล้วลองบันทึกอีกครั้ง


#### A2 – ที่อยู่/รหัสไปรษณีย์ไม่ตรงกับฐานข้อมูล

- ระบบตรวจสอบตำบล/อำเภอ/จังหวัด/รหัสไปรษณีย์กับตาราง `thai_locations`
- พบว่าข้อมูลที่กรอกไม่ตรงกับ combination ที่ถูกต้อง
- ระบบแสดง popup เปรียบเทียบ:
  - ที่อยู่ที่ Branch Staff กรอก
  - ที่อยู่ที่ระบบแนะนำจากฐานข้อมูลอ้างอิง
- Branch Staff สามารถเลือกได้ 2 ทาง:

  1. **ยืนยันใช้ข้อมูลที่ระบบแนะนำ และไปต่อ**
     - ระบบปรับที่อยู่ตามข้อมูลแนะนำ
     - ตั้งค่า `address_validated = true`
     - อนุญาตให้บันทึก shipment และไปขั้นตอนถัดไป

  2. **ไม่ยืนยัน ให้พนักงานหน้าเคาน์เตอร์ตรวจสอบเพิ่มเติม**
     - ระบบไม่อนุญาตให้ยืนยันด้วยตัวเอง
     - แสดงข้อความ:
       > "ระบบไม่สามารถยืนยันที่อยู่นี้ได้ กรุณาแจ้งพนักงานหน้าเคาน์เตอร์เพื่อช่วยตรวจสอบและบันทึกข้อมูลให้"
     - (ออปชัน) บันทึกเป็น draft ที่มี flag `address_needs_staff_review = true`
       เพื่อให้พนักงานเปิดดูและแก้ไขตอนลูกค้ามาที่สาขา


#### A3 – VIP Lookup ล้มเหลว

- 6a. ระบบเรียก J&T VIP API แล้ว error (timeout / 500 ฯลฯ)  
- 6b. ระบบ log ข้อผิดพลาด และแสดงคำเตือนเล็ก ๆ เช่น “ไม่สามารถตรวจสอบ VIP ตอนนี้ได้”  
- 6c. ระบบตั้ง `vip_code = null` แต่ยังอนุญาตให้สร้าง shipment ต่อได้ → ดำเนินข้อ 7–12

#### A4 – DB หรือระบบภายในมีปัญหา

- 8a. ระบบบันทึก `shipments` ไม่สำเร็จ (เช่น DB ล่ม)  
- 8b. ระบบขึ้นข้อความ error ชัดเจน “ไม่สามารถบันทึกข้อมูลได้”  
- 8c. ไม่สร้าง QR, ไม่เปลี่ยนหน้า → พนักงานอาจลองใหม่ หรือแจ้งผู้ดูแลระบบ

---

## UC-02: Scan QR & Confirm Shipment in J&T (Branch System – Part 2)

### Overview
พนักงานใช้ QR Code ที่สร้างจาก UC-01 เพื่อดึงข้อมูล shipment ขึ้นมา  
ตรวจสอบ/เติมข้อมูลเพิ่มเติม (น้ำหนักจริง, ประเภทบริการ, COD) แล้วส่งงานเข้า J&T System

### Basic Info
- **Use Case ID:** UC-02  
- **Name:** Scan QR & Confirm Shipment in J&T  
- **Primary Actor:** Branch Staff  
- **Secondary Actors:** SmartShip System, J&T System  
- **Trigger:** พนักงานต้องการรับพัสดุเข้าระบบ J&T โดยใช้ QR จาก UC-01

### Goal
ดึงข้อมูล Shipment Draft จาก QR ให้เร็วที่สุด  
ตรวจสอบ/ปรับข้อมูลที่จำเป็น และบันทึกเข้าระบบ J&T พร้อมเปลี่ยนสถานะใน SmartShip

### Preconditions
- มี shipment สถานะ `draft` ถูกสร้างไว้ก่อน (จาก UC-01)  
- กล่องพัสดุมีสติ๊กเกอร์ QR หรือมี QR แสดงบนหน้าจอมือถือของลูกค้า  
- Branch Staff ล็อกอิน Staff Portal (หรือหน้า Integration) เรียบร้อย  
- ระบบ J&T พร้อมให้ใช้งาน (อาจเป็นเว็บ / POS / API)

### Postconditions (Success)
- shipment ใน SmartShip ถูกเปลี่ยนสถานะเป็น `confirmed` หรือ `sent_to_jt`  
- มีการบันทึกข้อมูลเข้าระบบ J&T สำเร็จ  
- มี timestamp `confirmed_at` และชื่อผู้ยืนยัน (`confirmed_by`)
- ตั้งค่า `address_validated = true` เสมอเมื่อส่งเข้า J&T สำเร็จ

### Postconditions (Failure)
- สถานะ shipment ยังเป็น `draft`  
- ไม่บันทึกข้อมูลใน J&T  
- ระบบแจ้งข้อผิดพลาดให้พนักงานทราบ

---

### Main Flow (Success Scenario)

1. Branch Staff รับกล่องพัสดุจากลูกค้าพร้อม QR (จาก UC-01)  
2. Branch Staff เปิดหน้าจอ “รับเข้าระบบ J&T (ส่วนที่ 2)” บน Staff Portal หรือหน้าพิเศษสำหรับสแกน  
3. ระบบเปิดหน้าสแกน QR (ผ่านกล้อง หรือใช้เครื่องอ่าน QR)  
4. Branch Staff สแกน QR ที่ติดอยู่บนกล่อง / บนมือถือของลูกค้า  
5. SmartShip System ถอดรหัส QR Payload → ได้ข้อมูล:
   - shipment_id (หรือข้อมูล mapping อื่น)  
   - branch code  
   - vip_code (ถ้ามี)  
   - ข้อมูลผู้ส่ง/ผู้รับ/ที่อยู่  
6. ระบบค้นหา shipment ในฐานข้อมูลด้วย `shipment_id`  
7. ถ้าพบ shipment สถานะ `draft`:
   - ระบบแสดงหน้าจอสรุปข้อมูล shipment ทั้งหมด  
   - แสดงช่องให้พนักงานกรอกเพิ่มเติม เช่น น้ำหนักจริง, ประเภทบริการ (ธรรมดา/ด่วน), COD ฯลฯ  
8. Branch Staff ตรวจสอบข้อมูลผู้ส่ง/ผู้รับ/ที่อยู่ ถ้าจำเป็นแก้ไขเล็กน้อย  
9. Branch Staff กรอกข้อมูลเพิ่มเติมที่จำเป็นต่อ J&T System  
10. Branch Staff กดปุ่ม “ยืนยันและส่งเข้า J&T”  
11. SmartShip System ดำเนินการ 2 ส่วน:
    1. บันทึกข้อมูลที่แก้ไขลง DB (update shipment)  
    2. ส่งข้อมูลชุดสุดท้ายไปยัง J&T System  
       - ผ่าน API หรือ  
       - ผ่านการกรอกอัตโนมัติ/ช่วยพนักงานบนหน้าจอ J&T (แล้วแต่การ implement)  
12. เมื่อได้รับการยืนยันจาก J&T:
    - ระบบเปลี่ยนสถานะ shipment เป็น `sent_to_jt` หรือ `confirmed`  
    - บันทึก `confirmed_at` และ `confirmed_by`  
13. ระบบแสดงข้อความ “รับเข้าระบบ J&T สำเร็จ”  
14. Branch Staff ดำเนินการชั่งน้ำหนัก/รับเงิน/ปิดงาน ตามขั้นตอนปกติของสาขา → จบ UC-02

---

### Alternative & Exception Flows

#### B1 – ไม่พบ Shipment จาก QR

- 6a. ระบบไม่พบ shipment ที่ตรงกับ `shipment_id` จาก QR  
- 6b. ระบบแจ้งข้อความ “ไม่พบข้อมูลพัสดุจาก QR นี้ กรุณาตรวจสอบอีกครั้ง”  
- 6c. Branch Staff สามารถ:
  - ลองสแกน QR ใหม่ หรือ  
  - เลือกเมนู “สร้างพัสดุใหม่ที่เคาน์เตอร์” → ไปที่ UC-03

#### B2 – Shipment ไม่ได้อยู่ในสถานะ `draft`

- 7a. พบ shipment แต่สถานะเป็น `confirmed` / `sent_to_jt` ไปแล้ว  
- 7b. ระบบแจ้งเตือนว่า “พัสดุรายการนี้ถูกยืนยันไปแล้ว”  
- 7c. Branch Staff ตรวจสอบกับลูกค้า/ระบบ J&T และตัดสินใจว่าจะ:
  - ปล่อยผ่าน (ไม่ทำอะไรต่อ) หรือ  
  - เปิด flow แก้ไขพิเศษ (อยู่นอก scope MVP)

#### B3 – การส่งข้อมูลไป J&T ล้มเหลว

- 11a. SmartShip System ส่งข้อมูลเข้า J&T API แล้วได้รับ error (เช่น network / validation ผิด)  
- 11b. ระบบ log error และแสดงข้อความ เช่น “ส่งข้อมูลเข้า J&T ไม่สำเร็จ กรุณาลองใหม่”  
- 11c. ระบบยังไม่เปลี่ยนสถานะ shipment (คงไว้ที่ `draft` หรือ `pending_jt`)  
- 11d. Branch Staff สามารถกด “ลองใหม่” หรือกลับไปแก้ข้อมูลให้ถูกต้องแล้วกดส่งอีกครั้ง

#### B4 – ข้อมูล address/รหัสไปรษณีย์ผิด

- 8a. ขณะตรวจสอบข้อมูล ระบบตรวจเจอความผิดปกติ (เช่น รหัสไปรษณีย์ไม่ตรงจังหวัด)  
- 8b. ระบบแจ้งเตือนบนหน้าจอให้ Branch Staff ตรวจอีกครั้ง (อาจใช้ rule ธรรมดาหรือ AI ช่วย)  
- 8c. Branch Staff แก้ไขข้อมูลให้ถูกก่อนกด “ยืนยันและส่งเข้า J&T”  

---
